<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="/static/stylesPropio.css">

     <title>Procesamiento de Video ESP32-CAM - Completo</title>
</head>
<body>
     <div class="container">
          <div class="header">
               <h1>üé• Sistema Completo de Procesamiento de Video ESP32-CAM</h1>
               <p>An√°lisis avanzado de imagen en tiempo real con operaciones morfol√≥gicas</p>
          </div>
          
          <div class="nav-tabs">
               <button class="nav-tab active" onclick="window.location.href='/'">
                    üìπ Procesamiento en Vivo
               </button>
               <button class="nav-tab" onclick="window.location.href='/morphological'">
                    üè• Operaciones Morfol√≥gicas (Im√°genes M√©dicas)
               </button>
          </div>
          
          <div class="controls">
               <button class="btn btn-normal active" onclick="setMode('normal')" id="btn-normal">
                    üìπ Normal
               </button>
               <button class="btn btn-lighting" onclick="setMode('lighting')" id="btn-lighting">
                    üí° Iluminaci√≥n
               </button>
               <button class="btn btn-noise" onclick="setMode('noise')" id="btn-noise">
                    üîä Ruido Gaussiano
               </button>
               <button class="btn btn-salt" onclick="setMode('salt_pepper')" id="btn-salt_pepper">
                    üßÇ Sal y Pimienta
               </button>
               <button class="btn btn-edges" onclick="setMode('edges')" id="btn-edges">
                    üîç Detecci√≥n de Bordes
               </button>
               <button class="btn btn-background" onclick="setMode('background')" id="btn-background">
                    üé≠ Eliminaci√≥n de Fondo
               </button>
          </div>
          
          <div class="video-container">
               <img src="{{ url_for('video_stream') }}" alt="Video Stream">
          </div>
          
          <div class="info-panel">
               <div class="info-box" id="info-normal">
                    <h3>üìπ Modo Normal</h3>
                    <p>Visualizaci√≥n directa del video capturado por la c√°mara ESP32-CAM con contador de FPS en tiempo real.</p>
               </div>
               
               <div class="info-box" id="info-lighting" style="display:none;">
                    <h3>üí° Mejora de Iluminaci√≥n</h3>
                    <p>Compara tres t√©cnicas de mejora de iluminaci√≥n:</p>
                    <ul>
                         <li><strong>Ecualizaci√≥n de Histograma:</strong> Redistribuye intensidades para maximizar contraste global</li>
                         <li><strong>CLAHE:</strong> Ecualizaci√≥n adaptativa que limita la amplificaci√≥n en regiones locales</li>
                         <li><strong>Correcci√≥n Gamma:</strong> Transformaci√≥n no lineal (V_out = V_in^gamma) que ajusta brillo preservando detalles</li>
                    </ul>
               </div>
               
               <div class="info-box" id="info-noise" style="display:none;">
                    <h3>üîä Generaci√≥n y Reducci√≥n de Ruido Gaussiano/Speckle</h3>
                    <p>Demostraci√≥n de tipos de ruido y t√©cnicas de filtrado:</p>
                    <ul>
                         <li><strong>Ruido Gaussiano:</strong> Ruido aditivo con distribuci√≥n normal N(Œº, œÉ¬≤)</li>
                         <li><strong>Ruido Speckle:</strong> Ruido multiplicativo com√∫n en im√°genes de radar</li>
                         <li><strong>Filtro Bilateral:</strong> Reduce ruido preservando bordes mediante filtrado espacial e intensidad</li>
                    </ul>
               </div>
               
               <div class="info-box" id="info-salt_pepper" style="display:none;">
                    <h3>üßÇ Ruido Sal y Pimienta con Filtros Comparativos</h3>
                    <p><strong>Visualizaci√≥n en grid 2x3:</strong></p>
                    <ul>
                         <li><strong>Original:</strong> Imagen capturada sin procesar</li>
                         <li><strong>Salt & Pepper:</strong> Ruido impulsivo (p√≠xeles blancos=sal, negros=pimienta)</li>
                         <li><strong>Median Filter (OpenCV):</strong> Reemplaza cada p√≠xel con la mediana de su vecindario - <em>Mejor para sal y pimienta</em></li>
                         <li><strong>Blur Filter (OpenCV):</strong> Promedio simple de p√≠xeles vecinos</li>
                         <li><strong>Gaussian Filter (OpenCV):</strong> Promedio ponderado con distribuci√≥n gaussiana</li>
                         <li><strong>PyTorch Conv Filter:</strong> Convoluci√≥n usando torch.nn.functional.conv2d con kernel uniforme</li>
                    </ul>
                    
                    <h4 style="margin-top: 20px; color: #667eea;">üìä Comparaci√≥n de Resultados:</h4>
                    <table class="comparison-table">
                         <tr>
                              <th>Filtro</th>
                              <th>Efectividad</th>
                              <th>Velocidad</th>
                              <th>Preservaci√≥n de Bordes</th>
                              <th>Mejor Uso</th>
                         </tr>
                         <tr>
                              <td><strong>Median</strong></td>
                              <td>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
                              <td>Ruido sal y pimienta</td>
                         </tr>
                         <tr>
                              <td><strong>Blur</strong></td>
                              <td>‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê</td>
                              <td>Suavizado r√°pido general</td>
                         </tr>
                         <tr>
                              <td><strong>Gaussian</strong></td>
                              <td>‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê</td>
                              <td>Ruido gaussiano</td>
                         </tr>
                         <tr>
                              <td><strong>PyTorch Conv</strong></td>
                              <td>‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê‚≠ê</td>
                              <td>‚≠ê‚≠ê‚≠ê</td>
                              <td>Procesamiento GPU/personalizado</td>
                         </tr>
                    </table>
                    
                    <p style="margin-top: 15px;"><strong>Conclusi√≥n:</strong> El filtro de mediana obtiene los mejores resultados para ruido sal y pimienta porque es robusto a valores at√≠picos (outliers). Los filtros basados en promedio (Blur, Gaussian, PyTorch Conv) tienden a difuminar m√°s la imagen.</p>
               </div>
               
               <div class="info-box" id="info-edges" style="display:none;">
                    <h3>üîç Detecci√≥n de Bordes - Comparaci√≥n con/sin Suavizado</h3>
                    <p><strong>Visualizaci√≥n en grid 2x3:</strong></p>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">Algoritmos Implementados:</h4>
                    <ul>
                         <li><strong>Sobel:</strong> Usa kernels de convoluci√≥n para detectar gradientes horizontales y verticales
                              <ul>
                                   <li>Kernel X: [[-1,0,1], [-2,0,2], [-1,0,1]]</li>
                                   <li>Kernel Y: [[-1,-2,-1], [0,0,0], [1,2,1]]</li>
                                   <li>Magnitud: ‚àö(Gx¬≤ + Gy¬≤)</li>
                              </ul>
                         </li>
                         <li><strong>Canny:</strong> Algoritmo multi-etapa (Gaussian ‚Üí Gradientes ‚Üí Non-max suppression ‚Üí Hysteresis)
                              <ul>
                                   <li>M√°s sofisticado, bordes m√°s precisos</li>
                                   <li>Usa umbrales duales (50, 150) para detecci√≥n</li>
                              </ul>
                         </li>
                         <li><strong>Laplaciano:</strong> Detecta cambios de segunda derivada
                              <ul>
                                   <li>Kernel: [[0,1,0], [1,-4,1], [0,1,0]]</li>
                                   <li>Sensible al ruido</li>
                              </ul>
                         </li>
                    </ul>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">üìä Impacto del Suavizado Previo:</h4>
                    <table class="comparison-table">
                         <tr>
                              <th>Algoritmo</th>
                              <th>Sin Blur</th>
                              <th>Con Blur (Gaussian 5x5)</th>
                              <th>Recomendaci√≥n</th>
                         </tr>
                         <tr>
                              <td><strong>Sobel</strong></td>
                              <td>M√°s ruido, bordes detallados</td>
                              <td>Bordes m√°s limpios, menos ruido</td>
                              <td>‚úÖ Con blur para im√°genes ruidosas</td>
                         </tr>
                         <tr>
                              <td><strong>Canny</strong></td>
                              <td>Ya incluye Gaussian interno</td>
                              <td>M√°s suave, puede perder detalles</td>
                              <td>‚ö†Ô∏è Sin blur adicional usualmente</td>
                         </tr>
                         <tr>
                              <td><strong>Laplacian</strong></td>
                              <td>Muy sensible al ruido</td>
                              <td>Necesario para reducir ruido</td>
                              <td>‚úÖ Siempre con blur</td>
                         </tr>
                    </table>
                    
                    <p style="margin-top: 15px;"><strong>Conclusi√≥n:</strong> El suavizado previo es crucial para Laplaciano y beneficioso para Sobel en im√°genes ruidosas. Canny ya incorpora suavizado gaussiano en su primera etapa, por lo que blur adicional puede ser redundante.</p>
               </div>
               
               <div class="info-box" id="info-background" style="display:none;">
                    <h3>üé≠ Eliminaci√≥n de Fondo</h3>
                    <p>Utiliza el algoritmo MOG2 (Mixture of Gaussians) para segmentar foreground y background:</p>
                    <ul>
                         <li><strong>M√°scara:</strong> Visualizaci√≥n de p√≠xeles clasificados como foreground (blanco)</li>
                         <li><strong>Foreground Only:</strong> Resultado de aplicar operaci√≥n bitwise AND con la m√°scara</li>
                         <li>El sistema se adapta autom√°ticamente a cambios de iluminaci√≥n</li>
                         <li>Incluye detecci√≥n de sombras (p√≠xeles grises en la m√°scara)</li>
                    </ul>
               </div>
          </div>
     </div>
     
     <div class="status" id="status">
          Modo: Normal
     </div>
     
     <script>
          let currentMode = 'normal';
          
          function setMode(mode) {
               fetch(`/set_mode/${mode}`)
                    .then(response => response.json())
                    .then(data => {
                         if (data.status === 'success') {
                              // Actualizar botones activos
                              document.querySelectorAll('.btn').forEach(btn => {
                                   btn.classList.remove('active');
                              });
                              document.getElementById(`btn-${mode}`).classList.add('active');
                              
                              // Actualizar informaci√≥n
                              document.querySelectorAll('.info-box').forEach(box => {
                                   box.style.display = 'none';
                              });
                              document.getElementById(`info-${mode}`).style.display = 'block';
                              
                              // Actualizar status
                              const modeNames = {
                                   'normal': 'Normal',
                                   'lighting': 'Mejora de Iluminaci√≥n',
                                   'noise': 'Ruido Gaussiano/Speckle',
                                   'salt_pepper': 'Sal y Pimienta + Filtros',
                                   'edges': 'Detecci√≥n de Bordes',
                                   'background': 'Eliminaci√≥n de Fondo'
                              };
                              document.getElementById('status').textContent = `Modo: ${modeNames[mode]}`;
                              
                              currentMode = mode;
                         }
                    })
                    .catch(error => {
                         console.error('Error:', error);
                    });
          }
     </script>
</body>
</html>